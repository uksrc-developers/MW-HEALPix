# MW-HEALPix
---
This repository contains all the code relevant to running HEALPix as part of the Multiwave Demonstrator Case.


## Introduction

The code contained in this repository use the HEALPix function ([https://healpix.sourceforge.io/](https://healpix.sourceforge.io/)) to divide the optical, radio and Gaussian catalogues required in the MULTIWAVE demonstrator case pipeline into HEALpix areas. This code takes in the radio source catalogue and Gaussian region catalogue outputs from the PySDBSF step of the pipe line, and the combined optical catalogue generated by cross matching between the optical catalogues covering the sky area, matching the same radio sky area. The outputs are smaller radio, Gaussian, optical catalogues as fits files, for each of the HEALPix areas, and a combined catalogue which includes the central HEALPix area and its eight nearest neighbours.


## Hardware and Software

All the software to run the code is contained inside the singularity container.

The code can be memory intesive depending on the size of the optical catalogue that is being loaded.

For LoTSS DR2 the recommended hardware requirements were:
* 4 CPUs
* 50 GB RAM
* 500 GB hard disk space


## Directory Structure

When the code is run the first argument is a working directory. Within this directory the code is expecting to find a `/data` directory, under which the outputs will appear in the `/outputs` directory. 

As the following arguments are the input catalogues these should be stored in the `/data` directory.

```bash

working_directory
├── data/
│   ├── outputs/
│      ├── hp_#/
│      ├── hp_#/
│      ├── hp_#/
│      ... 

```



## Inputs and outputs

*The inputs are:*

The code currently takes in four inputs. These are:

1.	The base directory you wish to work from
2.	The optical catalogue to healpix stored in your `/data` directory
3.	The radio catalogue to healpix stored in your `/data` directory
4.	The radio Gaussian catalogue to healpix stored in your `/data` directory

A `/data` directory will need to exist to run the code as this is where the outputs will go, but if the inputs are somewhere else that is fine. Just be aware this will change the input pathways that you type.

*The outputs are:*

The output of the healpix code is currently saving to `/yourbase/projectarea/data/outputs/`. The `/outputs` folder is created and the `/data` folder is expected to already exist. The folders inside `/outputs` are for each individual healpix area and are labelled `hp_#` where # is the number of the healpix region. You will have to go into the script and change the words `data`, `outputs`, and `hp_`, if you want it to save to a different folder, within your “working from directory”.

There are currently six catalogues outputted, where hp# is the number of the healpix region:

1.	radio_hp#.fits		The radio catalogue of all sources in healpix region
2.	gaussian_hp#.fits	The radio catalogue of all Gaussians in healpix region
3.	optical_hp#.fits	The optical catalogue of all sources in healpix region
4.	radio_nn_hp#.fits	The radio catalogue of all sources in healpix region and nearest neighbour regions
5.	gaussian_nn_hp#.fits	The radio catalogue of all Gaussians in healpix region and nearest neighbour regions
6.	optical_nn_hp#.fits	The optical catalogue of all sources in healpix region and nearest neighbour regions


Within each radio source catalogue (radio_hp# and radio_hp#_nn) there is a column `rhpix`, which contains the healpix region number associated to the source.
Within each radio Gaussian catalogue (gaussian_hp# and gaussian_hp#_nn) there is a column `ghpix`, which contains the healpix region number associated to the source.
Within each optical source catalogue (optical_hp# and optical_hp#_nn) there is a column `ohpix`, which contains the healpix region number associated to the source.

When it runs it will print onscreen which catalogues have been created, and which already exist. If a catalogue already exists, the code does not re-create it.



## Running MW-HEALPix

### Download the data

Download the following catalogues directly from the [LOFAR-surveys](https://lofar-surveys.org/dr2_release.html) website:

**Radio catalogues**
* Non-redundant source catalogue v1.1 (with source mask information)
* Non-redundant Gaussian catalogue v1.1

Download the optical catalogue from [here](https://lofar-surveys.org/public/DR2/optical/dr2_combined.fits).

### Run the code

Having cloned the repo, first the container needs to be built.

```bash
singularity build --fakeroot --force HPdef.def HPcontainer.sif
```

The file to run is healpix_cats.py, which is done through the container.

To run this:

```bash
singularity shell --bind /your/working/directory/Data/,/your/cloned/directory/ HPcontainer.sif
```
This line enters the container. Make sure the directory containing the input data and where the output data is going, and the directory which has been cloned and contains the script to run have been bound to the container. The cursor will show `Apptainer>`.

```bash
python /path/to/script/healpix_cats.py /path/to/working/directory/ /path/to/{optical_catalogue_name}.fits /path/to/Data/{radio_catalogue_name}.fits /path/to/{gaussian_catalogue_name}.fits
```
This line runs the HEALPix script inside the container. You need: the directory you want to work in, the optical data, the radio source data, and the radio Gaussian data.
The names of the optical, radio, and Gaussain catalogues have to be inserted.


## Future Work


The code maybe adjusted so that it creates directories for each HEALPix area. This would mean that the six output catalogues would go into an individual directory, identified by HEALPix number, inside the original output directory. This change maybe added as a way to allow for easier batching in step further down the pipeline.


## External links

*The relevant Jira tickets are as follows:*

* [TEAL-685: Initial HEALPix Code](https://jira.skatelescope.org/browse/TEAL-745)
    * This ticket looks at the creation of the above HEALPix code
* [TEAL-685: Explore HEALPix Areas for LR](https://jira.skatelescope.org/browse/TEAL-685)
    * This ticket looks at the initial work done into using the HEALPix areas in the likelihood ratio code


## List of developers and Collaborators


Barkus, B.

Hardcastle, M. J.
